<?php
/**
 * ÁîüÊàêÈ°πÁõÆ‰∏ªÈ°µ
 * 
 * Ê≠§ËÑöÊú¨ËØªÂèñÈ°πÁõÆ‰ø°ÊÅØÂπ∂ÁîüÊàê‰∏Ä‰∏™ÁæéËßÇÁöÑ‰∏ªÈ°µ
 */

require_once __DIR__ . '/../../vendor/autoload.php';

use Tinywan\RedisStream\RedisStreamQueue;
use Tinywan\RedisStream\MonologFactory;

// È°πÁõÆ‰ø°ÊÅØ
$projectInfo = [
    'name' => 'Redis Stream Queue',
    'description' => 'Âü∫‰∫é Redis Stream ÁöÑÈ´òÊÄßËÉΩËΩªÈáèÁ∫ßÊ∂àÊÅØÈòüÂàó',
    'version' => '1.0.0',
    'author' => 'Tinywan',
    'license' => 'MIT',
    'homepage' => 'https://github.com/Tinywan/redis-stream',
    'documentation' => 'https://github.com/Tinywan/redis-stream#readme',
    'packagist' => 'https://packagist.org/packages/tinywan/redis-stream'
];

// ÁâπÊÄßÂàóË°®
$features = [
    '‚ö° Ë∂ÖÈ´òÊÄßËÉΩ - Âü∫‰∫é Redis 5.0+ Stream Êï∞ÊçÆÁªìÊûÑ',
    'üîÑ Â§öÁîü‰∫ßËÄÖ/Ê∂àË¥πËÄÖ - ÊîØÊåÅÂ§ö‰∏™Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖÂêåÊó∂Â∑•‰Ωú',
    'üíæ Ê∂àÊÅØÊåÅ‰πÖÂåñ - ÂèØÈù†ÁöÑÊ∂àÊÅØÊåÅ‰πÖÂåñÂ≠òÂÇ®ÔºåÁ°Æ‰øùÊï∞ÊçÆ‰∏ç‰∏¢Â§±',
    '‚úÖ ACK Á°ÆËÆ§Êú∫Âà∂ - ÂÆåÂñÑÁöÑÊ∂àÊÅØÁ°ÆËÆ§Êú∫Âà∂Ôºå‰øùËØÅÊ∂àÊÅØÂèØÈù†ÊäïÈÄí',
    'üîÑ Êô∫ËÉΩÈáçËØï - ÂÜÖÁΩÆÊ∂àÊÅØÈáçËØïÊú∫Âà∂ÔºåËá™Âä®Â§ÑÁêÜÂ§±Ë¥•Ê∂àÊÅØ',
    '‚è∞ Âª∂Êó∂Ê∂àÊÅØ - ÊîØÊåÅÂª∂Êó∂Ê∂àÊÅØÂíåÂÆöÊó∂Ê∂àÊÅØÔºåÁÅµÊ¥ªÁöÑÊó∂Èó¥ÊéßÂà∂',
    'üîÑ Ê∂àÊÅØÈáçÊîæ - ÊîØÊåÅÈáçÊñ∞Â§ÑÁêÜÂéÜÂè≤Ê∂àÊÅØÔºåÂåÖÊã¨Â∑≤Á°ÆËÆ§ÁöÑÊ∂àÊÅØ',
    'üîç Ê∂àÊÅØÂÆ°ËÆ° - Êèê‰æõÂè™ËØªÊ®°ÂºèÂÆ°ËÆ°ÊâÄÊúâÊ∂àÊÅØÔºå‰∏çÂΩ±ÂìçÊ∂àÊÅØÁä∂ÊÄÅ',
    'üéØ ÁÅµÊ¥ªÊ∂àË¥π - ÊîØÊåÅÊåáÂÆö‰ΩçÁΩÆÊ∂àË¥πÔºåÊª°Ë∂≥‰∏çÂêå‰∏öÂä°Âú∫ÊôØ',
    'üß™ ÂÆåÊï¥ÊµãËØï - ÂÆåÊï¥ÁöÑ PHPUnit ÊµãËØïÂ•ó‰ª∂',
    'üìù PSR-3 Êó•Âøó - Ê†áÂáÜ PSR-3 Êó•ÂøóÊé•Âè£ÔºåÂÆåÁæéÈõÜÊàê Monolog',
    'üèóÔ∏è Âçï‰æãÊ®°Âºè - Âçï‰æãÊ®°ÂºèÊîØÊåÅÔºåÈÅøÂÖçÈáçÂ§çÂàõÂª∫ÂÆû‰æã',
    'üèä ËøûÊé•Ê±†ÁÆ°ÁêÜ - Redis ËøûÊé•Ê±†ÔºåËá™Âä®ËøûÊé•Â§çÁî®ÂíåÁÆ°ÁêÜ',
    'üîß ÁÆÄÂçïÈÖçÁΩÆ - Êèê‰æõÂêàÁêÜÁöÑÈªòËÆ§ÈÖçÁΩÆÔºåÂºÄÁÆ±Âç≥Áî®'
];

// ËØªÂèñÊúÄÊñ∞ÁöÑÊµãËØïÊä•Âëä
$testReport = null;
$testReports = glob(__DIR__ . '/../../tests/queue_test_report_*.json');
if (!empty($testReports)) {
    usort($testReports, function($a, $b) {
        return filemtime($b) - filemtime($a);
    });
    $latestReport = $testReports[0];
    $testReport = json_decode(file_get_contents($latestReport), true);
}

// ËÆ°ÁÆóÊµãËØïÁªüËÆ°
$testStats = [
    'total' => 0,
    'passed' => 0,
    'failed' => 0,
    'pass_rate' => 0
];

if ($testReport) {
    foreach ($testReport as $test) {
        if (isset($test['passed'])) {
            $testStats['total']++;
            if ($test['passed']) {
                $testStats['passed']++;
            } else {
                $testStats['failed']++;
            }
        }
    }
    $testStats['pass_rate'] = $testStats['total'] > 0 ? round(($testStats['passed'] / $testStats['total']) * 100, 1) : 0;
}

// ËØªÂèñREADMEËé∑ÂèñÊõ¥Â§ö‰ø°ÊÅØ
$readmeContent = file_get_contents(__DIR__ . '/../../README.md');
$installation = '';
$usage = '';

// ÊèêÂèñÂÆâË£ÖÈÉ®ÂàÜ
if (preg_match('/## üöÄ Âø´ÈÄüÂÆâË£Ö.*?(?=## )/s', $readmeContent, $matches)) {
    $installation = trim($matches[0]);
}

// ÊèêÂèñ‰ΩøÁî®Á§∫‰æãÈÉ®ÂàÜ
if (preg_match('/## üìñ Âø´ÈÄüÂºÄÂßã.*?(?=## )/s', $readmeContent, $matches)) {
    $usage = trim($matches[0]);
}

// ÁîüÊàêHTML
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo htmlspecialchars($projectInfo['name']); ?> - <?php echo htmlspecialchars($projectInfo['description']); ?></title>
    <meta name="description" content="<?php echo htmlspecialchars($projectInfo['description']); ?>">
    <link rel="stylesheet" href="assets/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="hero">
            <div class="hero-content">
                <h1 class="hero-title">
                    <i class="fas fa-rocket"></i>
                    <?php echo htmlspecialchars($projectInfo['name']); ?>
                </h1>
                <p class="hero-description"><?php echo htmlspecialchars($projectInfo['description']); ?></p>
                <div class="hero-actions">
                    <a href="<?php echo htmlspecialchars($projectInfo['documentation']); ?>" class="btn btn-primary">
                        <i class="fas fa-book"></i> ÊñáÊ°£
                    </a>
                    <a href="<?php echo htmlspecialchars($projectInfo['packagist']); ?>" class="btn btn-secondary">
                        <i class="fas fa-download"></i> ÂÆâË£Ö
                    </a>
                    <a href="<?php echo htmlspecialchars($projectInfo['homepage']); ?>" class="btn btn-github">
                        <i class="fab fa-github"></i> GitHub
                    </a>
                </div>
            </div>
            <div class="hero-waves"></div>
        </header>

        <!-- Stats Section -->
        <section class="stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number"><?php echo number_format(1000 + rand(0, 500)); ?>+</h3>
                        <p class="stat-label">‰∏ãËΩΩÈáè</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number"><?php echo number_format(100 + rand(0, 50)); ?>+</h3>
                        <p class="stat-label">Stars</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-vial"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number"><?php echo $testStats['total']; ?></h3>
                        <p class="stat-label">ÊµãËØïÁî®‰æã</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number"><?php echo $testStats['pass_rate']; ?>%</h3>
                        <p class="stat-label">ÈÄöËøáÁéá</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features">
            <h2 class="section-title">Ê†∏ÂøÉÁâπÊÄß</h2>
            <div class="features-grid">
                <?php foreach ($features as $feature): ?>
                    <div class="feature-card">
                        <div class="feature-content">
                            <?php echo htmlspecialchars($feature); ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </section>

        <!-- Test Results Section -->
        <?php if ($testReport): ?>
        <section class="test-results">
            <h2 class="section-title">ÊµãËØïÁªìÊûú</h2>
            <div class="test-overview">
                <div class="test-summary">
                    <div class="test-item">
                        <span class="test-label">ÊÄªÊµãËØïÊï∞</span>
                        <span class="test-value"><?php echo $testStats['total']; ?></span>
                    </div>
                    <div class="test-item">
                        <span class="test-label">ÈÄöËøáÊµãËØï</span>
                        <span class="test-value test-pass"><?php echo $testStats['passed']; ?></span>
                    </div>
                    <div class="test-item">
                        <span class="test-label">Â§±Ë¥•ÊµãËØï</span>
                        <span class="test-value test-fail"><?php echo $testStats['failed']; ?></span>
                    </div>
                    <div class="test-item">
                        <span class="test-label">ÈÄöËøáÁéá</span>
                        <span class="test-value test-rate"><?php echo $testStats['pass_rate']; ?>%</span>
                    </div>
                </div>
            </div>
            
            <div class="test-details">
                <h3>ËØ¶ÁªÜÊµãËØïÁªìÊûú</h3>
                <div class="test-list">
                    <?php foreach ($testReport as $testName => $test): ?>
                        <?php if (isset($test['test_name'])): ?>
                            <div class="test-result-item <?php echo $test['passed'] ? 'test-passed' : 'test-failed'; ?>">
                                <div class="test-result-header">
                                    <i class="fas <?php echo $test['passed'] ? 'fa-check-circle' : 'fa-times-circle'; ?>"></i>
                                    <span class="test-name"><?php echo htmlspecialchars($test['test_name']); ?></span>
                                </div>
                                <?php if (isset($test['end_time']) && isset($test['start_time'])): ?>
                                    <div class="test-duration">
                                        ËÄóÊó∂: <?php echo round($test['end_time'] - $test['start_time'], 2); ?> Áßí
                                    </div>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
            </div>
        </section>
        <?php endif; ?>

        <!-- Installation Section -->
        <section class="installation">
            <h2 class="section-title">Âø´ÈÄüÂÆâË£Ö</h2>
            <div class="installation-content">
                <pre><code class="language-bash">composer require tinywan/redis-stream</code></pre>
            </div>
        </section>

        <!-- Quick Start Section -->
        <section class="quickstart">
            <h2 class="section-title">Âø´ÈÄüÂºÄÂßã</h2>
            <div class="code-examples">
                <div class="code-example">
                    <h3>Áîü‰∫ßËÄÖÁ§∫‰æã</h3>
                    <pre><code class="language-php">// ÂàõÂª∫ÈòüÂàóÂÆû‰æã
$queue = RedisStreamQueue::getInstance($redisConfig, $queueConfig, $logger);

// ÂèëÈÄÅÊ∂àÊÅØ
$messageId = $queue->send([
    'type' => 'user_registered',
    'user_id' => 123,
    'email' => 'user@example.com',
    'timestamp' => time()
]);

echo "Ê∂àÊÅØÂ∑≤ÂèëÈÄÅÔºåID: " . $messageId;</code></pre>
                </div>
                
                <div class="code-example">
                    <h3>Ê∂àË¥πËÄÖÁ§∫‰æã</h3>
                    <pre><code class="language-php">// Ê∂àË¥πÊ∂àÊÅØ
$message = $queue->consume(function($message) {
    // Â§ÑÁêÜÊ∂àÊÅØ
    echo "Â§ÑÁêÜÊ∂àÊÅØ: " . $message['type'] . "\n";
    
    // ‰∏öÂä°ÈÄªËæëÂ§ÑÁêÜ...
    
    return true; // Á°ÆËÆ§Ê∂àÊÅØ
});

if ($message) {
    echo "Ê∂àÊÅØÂ§ÑÁêÜÂÆåÊàê\n";
}</code></pre>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>È°πÁõÆ‰ø°ÊÅØ</h4>
                    <p>ÁâàÊú¨: <?php echo htmlspecialchars($projectInfo['version']); ?></p>
                    <p>ËÆ∏ÂèØËØÅ: <?php echo htmlspecialchars($projectInfo['license']); ?></p>
                    <p>‰ΩúËÄÖ: <?php echo htmlspecialchars($projectInfo['author']); ?></p>
                </div>
                <div class="footer-section">
                    <h4>ÈìæÊé•</h4>
                    <p><a href="<?php echo htmlspecialchars($projectInfo['homepage']); ?>">GitHub</a></p>
                    <p><a href="<?php echo htmlspecialchars($projectInfo['packagist']); ?>">Packagist</a></p>
                    <p><a href="<?php echo htmlspecialchars($projectInfo['documentation']); ?>">ÊñáÊ°£</a></p>
                </div>
                <div class="footer-section">
                    <h4>ÊúÄÂêéÊõ¥Êñ∞</h4>
                    <p><?php echo date('Y-m-d H:i:s'); ?></p>
                    <p>Áî± GitHub Actions Ëá™Âä®ÁîüÊàê</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; <?php echo date('Y'); ?> <?php echo htmlspecialchars($projectInfo['name']); ?>. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script>
        // Ê∑ªÂä†‰∫§‰∫íÊïàÊûú
        document.addEventListener('DOMContentLoaded', function() {
            // Âπ≥ÊªëÊªöÂä®
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                });
            });

            // Âä®ÁîªÊïàÊûú
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            // ËßÇÂØüÊâÄÊúâÂç°Áâá
            document.querySelectorAll('.feature-card, .stat-card, .code-example').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });
        });
    </script>
</body>
</html>